var fibList = [1, 1];
var TimesPlus = [];
var PlusAtimesB = [];

function generateTimesAplusB() {
  a = getRandomIntInclusive(2,5);
  b= getRandomIntInclusive(2,5);
  for(let i=1; i<100; i++){
    var value  = (i * a) + (b + 2* a) ;
    TimesPlus.push(value);
  }
}

function generatePlusAtimesB() {
  a = getRandomIntInclusive(2,5);
  b= a + getRandomIntInclusive(2,5);
  for(let i=1; i<100; i++){
    var value  = (i + a) * b ;
    PlusAtimesB.push(value);
  }
}

function questionAlphabet(number){
  number = number % 26
  var value = number + 65;
  value = String.fromCharCode(value);
  console.log("ALPHABET", number, value)
  return value;
}


function questionAlphabet2(number){
  if(number<0) number=number + 26
  var value = number % 26;
  var value2 = (value + AlphaDiff ) % 26 ;
  value = String.fromCharCode(value+65);
  value2 = String.fromCharCode(value2+65);
  return value+ AlphaDelimiter +value2;
}

function generateFib(n){
  for(let i=2; i<n; i++){
    var value = fibList[i-1] + fibList[i-2];
    fibList.push(value);
  }
  return fibList;
}

function getRandomIntInclusive(min, max) {
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function generateQuestion(targetObj, obj, style){
  var starter = start
  for(let column=1; column <= 3; column++){
    var value 
    if(style==0) {
      value= fibList[starter]; 
    }
    if(style==1) {
      value= TimesPlus[starter]
    }
    if(style==2) {
      value= PlusAtimesB[starter]
    }
    targetObj.push(value);
    $("#" + obj + column).html(value);
    var disp = (value + "").length
    if(disp==6) $("#" + obj + column).css("font-size","16px")
    if(disp==5) $("#" + obj + column).css("font-size","22px")
    if(disp==4) $("#" + obj + column).css("font-size","28px")
    if(disp==3) $("#" + obj + column).css("font-size","36px")
    if(disp<=2) $("#" + obj + column).css("font-size","42px")
    if(disp<=1) $("#" + obj + column).css("font-size","46px")
     
  starter += step;
  }
  console.log(start, step, targetObj);
} 

function Questions() {
  styles =["FIB", "MATH1","MATH2", "ALPHABET"]
  A = [];
  B = [];
  C = [];
  style = getRandomIntInclusive(0,3);
  $("#questionStyle").html(styles[style])

  if(style==0 )
    {
      var divider = 1
      step = getRandomIntInclusive(1, 2);
      if (step==2) divider = 5
      start = getRandomIntInclusive(1,15/divider);
    }
  else
    {
      start = getRandomIntInclusive(1,20);
      step = getRandomIntInclusive(1, 10);
      if(style==3) {
        start = getRandomIntInclusive(1,10);
        step = getRandomIntInclusive(1, 3);
      }
    }
  generateQuestion(A,'A',style); 
  start += (1 + getRandomIntInclusive(1,2) ) *  step;
  generateQuestion(B, 'B',style);
  start +=  (1 + getRandomIntInclusive(1,2) ) *  step;
  generateQuestion(C,'C',style);
  var freq= getRandomIntInclusive(1,10)
  var loc = 3
  if(freq>=9) loc=1
  else
  if(freq>=6) loc=2
  console.log(freq, loc)
  Answers(loc)
 }


function xmur3(str) {
    for(var i = 0, h = 1779033703 ^ str.length; i < str.length; i++)
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = h << 13 | h >>> 19;
    return function() {
        h = Math.imul(h ^ h >>> 16, 2246822507);
        h = Math.imul(h ^ h >>> 13, 3266489909);
        return (h ^= h >>> 16) >>> 0;
    }
}


function sfc32(a, b, c, d) {
    return function() {
      a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0; 
      var t = (a + b) | 0;
      a = b ^ b >>> 9;
      b = c + (c << 3) | 0;
      c = (c << 21 | c >>> 11);
      d = d + 1 | 0;
      t = t + d | 0;
      c = c + t | 0;
      return (t >>> 0) / 4294967296;
    }
}

function mulberry32(a) {
    return function() {
      var t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
}

////=================================================

var seed = xmur3("apples");
// Output four 32-bit hashes to provide the seed for sfc32.
var rand = sfc32(seed(), seed(), seed(), seed());
// Output one 32-bit hash to provide the seed for mulberry32.
var rand = mulberry32(seed());
generateFib(50);
generateTimesAplusB();
generatePlusAtimesB();
var A = [];
var B = [];
var C = [];
var start
var step
var style
var quizStyle ///  0. Fibonacci....
var quizLayout /// 0. 3x3, 1, 4x4, 2, 6 on record 3. 10 on a record
var styles =["FIB", "MATH1","MATH2", "ALPHABET"]
///Questions() 
  

///=======================
function getValue(rowStyle, starter){
        if(rowStyle==0) {
          return fibList[starter]; 
        }
        if(rowStyle==1) {
          return TimesPlus[starter]
        }
        if(rowStyle==2) {
          return PlusAtimesB[starter]
        }
        if(rowStyle==3) {
          return questionAlphabet(starter)
        }
        if(rowStyle>=4) {
          return questionAlphabet2(starter)
        }

}

function generateQuestionStyle( firstLoc, numItemsPerLine, rowStyle){
  var starter = firstLoc
  var lineValue = ""
  for(var x=1; x<=numItemsPerLine; x++) {
        lineValue += getValue(rowStyle, starter) 
        if(x!=numItemsPerLine){
          lineValue += "^"
          starter += step;
        } 
  }
  return lineValue
} 

function getSingleQuestion(number, style, layout){
  var cols
  var result = ""
  var adj = 0
  if(style==3) {
    adj=1; // becasue Alpha Quiz is easy we don't allow very close letters
  }
  if(layout>=0 && layout<3 ) {
    //==> 3x3
    cols =  3
    if(layout==1) cols= 4
    if(layout==2) cols= 5
    step = getRandomIntInclusive(1+adj,2+adj)
    start = getRandomIntInclusive(1,15)
    if(layout==1) start = getRandomIntInclusive(1,10)    
    if(layout==2) start = getRandomIntInclusive(1,6)
    for( var y=1; y<= cols; y++) {
      result += generateQuestionStyle( start,  cols, style);
      if(y< cols){
        result += "~"; 
        start += (1 + getRandomIntInclusive(1,2) ) *  step;  
      }
    }
  }
  if(layout==3  || layout == 4) {
    // 6 items on a line
    cols = (layout==3) ? 6 : 10;
    step = getRandomIntInclusive(1+adj,2+adj)
    start = getRandomIntInclusive(1,15)
    result += generateQuestionStyle( start,  cols, style);
  }
  return result
}

function getQuestions(number) {
  A = [];
  B = [];
  C = [];
  var StylesName = ["Fibonacci", "Math1", "Math2", "Alphabet1", "Alphabet2"]
  Questions=[]
  Styles=[]
  Alpha=[]
  Answers=[]
  for(var x=1; x<=number; x++){
    quizStyle = 4;//getRandomIntInclusive(0,4);
    quizLayout = getRandomIntInclusive(0,3);  /// 0. 3x3, 1. 4x4, 2 5x5  3. 6 on a record  4. 10 on a record
    AlphaDiff = getRandomIntInclusive(0,2);
      /// make it more fun by randomly creating more character in between
    var delimiterStyle=getRandomIntInclusive(0,1)
    var limit =""
    for(var loop=0; loop<delimiterStyle; loop++){
        for(var times=0; times<=getRandomIntInclusive(0,1); times++)
        {
          var a1= getRandomIntInclusive(0,1)
          if(a1==0)
            {              
              limit += questionAlphabet(getRandomIntInclusive(0,26) )
            }
          else
            {
              limit +=  String.fromCharCode(getRandomIntInclusive(49,57) );
            }
        }
    }    
   console.log("DELIMITER", delimiterStyle, limit)
   AlphaDelimiter = limit
    
    var result = getSingleQuestion(x, quizStyle, quizLayout)
    Questions.push(result)
    Styles.push(quizStyle)
 
    Alpha.push(AlphaDiff + ":" + limit)
  } 
  //var selectedQ = getRandomIntInclusive(0,7) 
 // $("#questionStyle").html(StylesName[Styles[selectedQ]] +  "   Layout:" + quizLayout)
 // showQuestion(selectedQ, 1, $("#showAnswer").is(":checked"))  /// to be sub with the Answer Location
 }

function NextQuestion(){
  currentNumber++
  if(currentNumber> parseInt($("#numberQuestions").val())   ) {
    currentNumber=parseInt($("#numberQuestions").val())  
    return
  } 
  showQuestion(1,$("#showAnswer").is(":checked"))
  $("#currentQ").html(currentNumber)
}
function PrevQuestion(){
  currentNumber--
  if(currentNumber<=0) currentNumber=1
  showQuestion(1 , $("#showAnswer").is(":checked"))
  $("#currentQ").html(currentNumber)
}

function showQuestion(hide, showAnswer){
  var rowID = ["A", "B", "C", "D", "E"]
  var rows = Questions[currentNumber-1].split("~")
  console.log("Num Rows:" + rows.length)
  var cols = rows[0].split("^").length
  $("#draft").html("").css("width", cols * 100 + 30)
  var result=""
  var bgColor = ["Teal", "Brown", "Black", "Green", "Red", "Maroon"]
  var bg = bgColor[getRandomIntInclusive(0,5)]
  var bd = getRandomIntInclusive(1,8) * 6
  if(hide==undefined) hide =  getRandomIntInclusive(1,cols)
  var correctHide 
  for(var y=1; y<=rows.length; y++)
    {
      var value = rows[y-1].split("^")
        for(var x=1; x<= cols  ; x++) {
                  var display=value[x-1] + ""
                  var fs = 'font-size: '
                  fs += (48 - (display.length*4)) + "px;"
                  var highlight = " style='" + fs + "border-radius:" + bd +"px;background:" + bg +"'"
                  if(y==rows.length && x==hide) {
                    display="?"
                    correctHide= value[x-1] + ""
                    highlight=" style='border-radius:" + bd +"px;background:silver; color:Gold' "  
                  }
                  result += "<div " + highlight +" class='block' id='" + rowID[y-1] + "'>" + display +"</div>&nbsp;" 
        }
        result = "<div>" + result +"</div><hr style='background:none; height:1px;color:none'>"
    }
  ///=================
  var correctPosition = getRandomIntInclusive(1,6)
  $(".answer").html("").css("color","Black")
  $("#answer" + correctPosition).html(correctHide)
  var cv = parseInt(correctHide)
  if(isNaN(correctHide)) {
    //== Alpha, then get the quizStyle
    cv = correctHide.charAt(0).charCodeAt(0) - 65
    var style = Styles[currentNumber-1]
    console.log("Current Style of Record " + (currentNumber-1), style)
    if(style==4)
      {
        var AD = (Alpha[currentNumber-1]).split(":")
        AlphaDiff = parseInt(AD[0])
        AlphaDelimiter = AD[1]
      }
   if(showAnswer) $("#answer" + correctPosition).css("color", "Maroon")
    for (var x= (correctPosition + 1) ; x<=6; x++) {
        var diff = getRandomIntInclusive(1,3)
        cv += diff
        var value = (style==4) ? questionAlphabet2(cv): questionAlphabet(cv)
        console.log("CV",cv)
        $("#answer" + x).html(value)
    }
    cv = correctHide.charAt(0).charCodeAt(0) - 65
    for(var y=1; y<correctPosition; y++) {
        var diff = getRandomIntInclusive(1,3)
        cv = cv - diff
        var value = (style==4) ? questionAlphabet2(cv): questionAlphabet(cv)
        $("#answer" + (correctPosition-y)).html(value)
    }
  }
  else {
    //==== Number, then do this first because it is much easier
    var randSeed = parseInt(cv * 0.1)
    if(showAnswer) $("#answer" + correctPosition).css("color", "Maroon")
    for (var x= (correctPosition + 1) ; x<=6; x++) {
        var diff = getRandomIntInclusive(1,randSeed)
        cv += diff
       $("#answer" + x).html(cv)//.css("color", "Maroon")
    }
    cv = parseInt(correctHide)
    for(var y=1; y<correctPosition; y++) {
        var diff = getRandomIntInclusive(1,randSeed)
        cv = cv - diff
       $("#answer" + (correctPosition-y)).html(cv)
    }
  }
  $("#draft").html(result)
  console.log("RESULT", result)
  Answers=[]
  for(var x=1; x<=6; x++){
    Answers.push($("#answer" + x).html())
  }
  
  //console.log(result)
}

function requestAssess(number){
  console.clear()
  console.log("Number of Items", number)
  getQuestions(number)
}

var AlphaDelimiter=""
var AlphaDiff=0
var Questions=[]
var Styles=[]  
var Answers=[]
var Alpha=[]
var currentNumber
var id
$("#draft").html("")
$("#footer").hide()
$("#header").hide()



function goTakeTheExam(){
  var numQuestions = $("#numberQuestions").val()
  var secondsPerQuestion = 45
  var duration = numQuestions * secondsPerQuestion
  $("#countdownTimer").html("")
  requestAssess(numQuestions)
  $("#footer").show()
  $("#totalQ").html(numQuestions)
  currentNumber=0
  NextQuestion()
  $("#header").show()
  var timer = document.querySelector('#countdownTimer');
  clearInterval(id);
  startTimer(duration, timer);  
}

function startTimer(duration, display) {
    var timer = duration, minutes, seconds;
    id= setInterval(function () {
        minutes = parseInt(timer / 60, 10)
        seconds = parseInt(timer % 60, 10);
        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;
        display.textContent = minutes + ":" + seconds;
        if (--timer < 0) {
            timer = duration;
        }
    }, 1000);
}



$(".answer").click( function() {
  NextQuestion()
  
})
